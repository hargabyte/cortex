# .cxignore Language-Specific Research

Research document for implementing smart exclusion suggestions in cx.

## Overview

This document catalogs what needs to be detected and excluded for each language cx supports. The goal is to build data-driven heuristics that can suggest a `.cxignore` file, rather than hardcoding exclusions.

## The Core Problem

Each language ecosystem has:
1. **Dependency directories** - Third-party code that shouldn't be in your code graph
2. **Build outputs** - Compiled/bundled artifacts
3. **Generated code** - Machine-generated source files (protobufs, ORM, etc.)
4. **Configuration/lock files** - Not code, but sometimes parsed

The challenge: These vary wildly by language, and even within a language (e.g., npm vs yarn vs pnpm).

---

## Language-by-Language Analysis

### 1. JavaScript/TypeScript

**Dependency Directories:**
| Directory | Indicator | Notes |
|-----------|-----------|-------|
| `node_modules/` | Contains `package.json` files | Can be massive (100k+ files) |
| `.pnpm/` | pnpm store | Inside node_modules |
| `bower_components/` | Legacy | Rare now |

**Build Outputs:**
| Pattern | Detection Method |
|---------|------------------|
| `dist/` | Common convention |
| `build/` | Common convention |
| `.next/` | Next.js specific |
| `.nuxt/` | Nuxt.js specific |
| `out/` | Next.js export |
| `.output/` | Nitro/Nuxt |

**Minified/Bundled Files:**
| Pattern | Heuristic |
|---------|-----------|
| `*.min.js` | Filename pattern |
| `*.bundle.js` | Filename pattern |
| `*.chunk.js` | Webpack chunks |
| Files with avg line length > 500 chars | Minification indicator |
| Files with `//# sourceMappingURL=` | Has source map = likely bundled |

**Generated Code:**
| Pattern | Source |
|---------|--------|
| `*.d.ts` in `node_modules/` | Type declarations (generated) |
| `__generated__/` | GraphQL codegen, etc. |
| `*.generated.ts` | Various generators |
| `*.pb.ts`, `*_pb.ts` | Protobuf |
| `*.g.ts` | gRPC |

**Detection Strategy:**
1. Check for `package.json` in root → JS/TS project
2. If `node_modules/` exists and has >1000 entities → suggest exclude
3. Look for source maps (`*.map`) alongside JS files → bundled output
4. Calculate avg line length; if >500 chars → likely minified

---

### 2. Go

**Dependency Directories:**
| Directory | Indicator | Notes |
|-----------|-----------|-------|
| `vendor/` | Contains `modules.txt` | Official vendoring (Go 1.14+) |

**Build Outputs:**
| Pattern | Notes |
|---------|-------|
| Binary files (no extension) | Hard to detect without file inspection |

**Generated Code:**
| Pattern | Source |
|---------|--------|
| `*.pb.go` | Protobuf |
| `*_gen.go` | Various generators |
| `*.gen.go` | Various generators |
| `*_generated.go` | Kubernetes, etc. |
| `//go:generate` comment in file | Indicates generated output nearby |
| `// Code generated .* DO NOT EDIT` | Standard generated file header |
| `mock_*.go`, `*_mock.go` | Mock generators |
| `zz_generated.*.go` | Kubernetes controller-gen |

**Detection Strategy:**
1. Check for `go.mod` in root → Go project
2. If `vendor/` exists with `modules.txt` → vendored deps
3. Scan first line of `.go` files for `// Code generated` → generated
4. Check for `*.pb.go` pattern → protobuf

**Special Consideration:**
Go's `vendor/` is more nuanced than `node_modules`. Some projects vendor their own internal packages. Check if `vendor/` contains modules from different domains (github.com/*, etc.) vs internal paths.

---

### 3. Python

**Dependency Directories:**
| Directory | Indicator | Notes |
|-----------|-----------|-------|
| `venv/`, `.venv/`, `env/` | Contains `pyvenv.cfg` | Virtual environments |
| `site-packages/` | Inside venv | Actual packages |
| `.tox/` | Tox testing | Multiple venvs |
| `.nox/` | Nox testing | Multiple venvs |
| `__pypackages__/` | PEP 582 | Less common |

**Build Outputs:**
| Pattern | Notes |
|---------|-------|
| `*.pyc` | Bytecode |
| `__pycache__/` | Bytecode cache |
| `*.egg-info/` | Package metadata |
| `dist/` | Built distributions |
| `build/` | Build artifacts |
| `*.so`, `*.pyd` | Compiled extensions |

**Generated Code:**
| Pattern | Source |
|---------|--------|
| `*_pb2.py` | Protobuf |
| `*_pb2_grpc.py` | gRPC |
| `*_generated.py` | Various |
| Files with `# Generated by` header | Various generators |

**Detection Strategy:**
1. Check for `requirements.txt`, `setup.py`, `pyproject.toml`, or `Pipfile` → Python project
2. If directory contains `pyvenv.cfg` → it's a virtual environment
3. Check for `__pycache__/` directories → bytecode (always exclude)
4. Scan first 5 lines for `# Generated` comments

---

### 4. Rust

**Dependency Directories:**
| Directory | Indicator | Notes |
|-----------|-----------|-------|
| None by default | Rust uses system-wide cache | `~/.cargo/` |

**Build Outputs:**
| Pattern | Notes |
|---------|-------|
| `target/` | All build artifacts |
| `target/debug/` | Debug builds |
| `target/release/` | Release builds |
| `target/doc/` | Generated docs |

**Generated Code:**
| Pattern | Source |
|---------|--------|
| `*.rs` in `target/` | Build artifacts |
| Files with `// @generated` | Protobuf, etc. |
| `build.rs` output | Build scripts |

**Detection Strategy:**
1. Check for `Cargo.toml` → Rust project
2. `target/` directory always excluded (build artifacts, not dependencies)
3. Rust is simpler than most - mainly just exclude `target/`

---

### 5. Java

**Dependency Directories:**
| Directory | Indicator | Notes |
|-----------|-----------|-------|
| `.m2/` | Maven local repo | Usually in home dir |
| `.gradle/` | Gradle cache | Project or home dir |
| `lib/` | Manual JAR management | Legacy pattern |

**Build Outputs:**
| Pattern | Notes |
|---------|-------|
| `target/` | Maven |
| `build/` | Gradle |
| `out/` | IntelliJ |
| `bin/` | Eclipse |
| `*.class` | Compiled |
| `*.jar` | Archives |

**Generated Code:**
| Pattern | Source |
|---------|--------|
| `target/generated-sources/` | Maven plugins |
| `build/generated/` | Gradle plugins |
| `*_.java` | JPA metamodel |
| `Q*.java` | QueryDSL |
| `*Mapper.java`, `*MapperImpl.java` | MapStruct |
| Files with `@Generated` annotation | Various |
| `*Grpc.java` | gRPC |

**Detection Strategy:**
1. Check for `pom.xml` → Maven; `build.gradle` → Gradle
2. `target/` or `build/` always excluded
3. Check for `target/generated-sources/` subdirs
4. Scan for `@Generated` or `@javax.annotation.Generated` annotations

---

### 6. Kotlin

**Same as Java, plus:**

**Generated Code:**
| Pattern | Source |
|---------|--------|
| `build/generated/source/kapt/` | KAPT annotation processing |
| `build/generated/source/ksp/` | KSP annotation processing |
| `*.kapt.kt` | KAPT stubs |

**Detection Strategy:**
1. Check for `build.gradle.kts` or `.kt` files
2. Same exclusions as Java
3. Additional KAPT/KSP directories

---

### 7. C#/.NET

**Dependency Directories:**
| Directory | Indicator | Notes |
|-----------|-----------|-------|
| `packages/` | Legacy NuGet | Older projects |
| NuGet cache | System-wide | Not in project |

**Build Outputs:**
| Pattern | Notes |
|---------|-------|
| `bin/` | Compiled output |
| `obj/` | Intermediate files |
| `*.dll` | Compiled assemblies |
| `*.exe` | Executables |

**Generated Code:**
| Pattern | Source |
|---------|--------|
| `obj/Debug/net*/` | Generated during build |
| `*.g.cs` | Source generators |
| `*.designer.cs` | WinForms/WPF designers |
| `*.generated.cs` | Various |
| `AssemblyInfo.cs` | Auto-generated |
| Files with `[GeneratedCode]` attribute | Various |

**Detection Strategy:**
1. Check for `*.csproj`, `*.sln` → .NET project
2. `bin/` and `obj/` always excluded
3. Check `obj/project.assets.json` for dependency info

---

### 8. C/C++

**Dependency Directories:**
| Directory | Indicator | Notes |
|-----------|-----------|-------|
| `vcpkg_installed/` | vcpkg | Contains `vcpkg/` subdir |
| `_deps/` | CMake FetchContent | Build-time deps |
| `external/`, `third_party/`, `3rdparty/` | Manual vendoring | Common conventions |
| `conan/` | Conan cache | Sometimes in project |

**Build Outputs:**
| Pattern | Notes |
|---------|-------|
| `build/` | CMake out-of-source |
| `cmake-build-*/` | CLion convention |
| `*.o`, `*.obj` | Object files |
| `*.a`, `*.lib` | Static libraries |
| `*.so`, `*.dll`, `*.dylib` | Dynamic libraries |

**Generated Code:**
| Pattern | Source |
|---------|--------|
| `*.pb.h`, `*.pb.cc` | Protobuf |
| `*_generated.h` | FlatBuffers |
| `moc_*.cpp`, `*.moc` | Qt MOC |
| `ui_*.h` | Qt UIC |
| `qrc_*.cpp` | Qt RCC |
| Files with `// Generated by` header | Various |

**Detection Strategy:**
1. Check for `CMakeLists.txt`, `Makefile`, `*.vcxproj`
2. C/C++ is hardest - no standard package location
3. Look for vcpkg.json, conanfile.txt/py for package manager hints
4. Check for common vendor directory names

---

### 9. PHP

**Dependency Directories:**
| Directory | Indicator | Notes |
|-----------|-----------|-------|
| `vendor/` | Contains `autoload.php` | Composer standard |

**Build Outputs:**
| Pattern | Notes |
|---------|-------|
| None typically | Interpreted language |

**Generated Code:**
| Pattern | Source |
|---------|--------|
| `vendor/composer/` | Autoloader |
| `var/cache/` | Symfony cache |
| `bootstrap/cache/` | Laravel cache |
| `storage/framework/` | Laravel framework files |

**Detection Strategy:**
1. Check for `composer.json` → PHP project
2. If `vendor/` exists with `autoload.php` → Composer deps
3. Similar to Node - check entity count ratio

---

### 10. Ruby

**Dependency Directories:**
| Directory | Indicator | Notes |
|-----------|-----------|-------|
| `vendor/bundle/` | Contains gems | Bundler with --path |
| `vendor/cache/` | Cached gems | Deployment mode |

**Build Outputs:**
| Pattern | Notes |
|---------|-------|
| `tmp/` | Rails temp files |
| `log/` | Rails logs |

**Generated Code:**
| Pattern | Source |
|---------|--------|
| `db/schema.rb` | Rails schema dump |
| `*.rbi` | Sorbet type definitions |

**Detection Strategy:**
1. Check for `Gemfile` → Ruby project
2. Check `.bundle/config` for path settings
3. If `vendor/bundle/` exists → vendored gems

---

## Cross-Language Patterns

### Universal Excludes
These should probably always be suggested:
- `.git/` - Version control
- `.svn/`, `.hg/` - Other VCS
- `.idea/`, `.vscode/` - IDE settings
- `*.log` - Log files
- `.DS_Store`, `Thumbs.db` - OS artifacts

### Protobuf/gRPC (All Languages)
| Language | Generated Pattern |
|----------|-------------------|
| Go | `*.pb.go` |
| Python | `*_pb2.py`, `*_pb2_grpc.py` |
| TypeScript | `*.pb.ts`, `*_pb.ts` |
| Java | `*Grpc.java`, `*OuterClass.java` |
| C++ | `*.pb.h`, `*.pb.cc` |
| C# | `*.g.cs` (in Grpc.Tools output) |
| Rust | `*.rs` in `OUT_DIR` |

### Generated File Header Detection
Many generators add headers. Scan first 10 lines for:
```
// Code generated .* DO NOT EDIT
// @generated
// Generated by
// AUTO-GENERATED
// This file was automatically generated
/* eslint-disable */ (at top of file)
# Generated by
```

---

## Implementation Recommendations

### Phase 1: Directory-Based Detection
Start with the easy wins:
1. Detect project type from manifest files
2. Check for known dependency directories
3. Calculate entity count per top-level directory
4. Suggest excluding directories with >X% of total entities

### Phase 2: File-Based Detection
Add more precision:
1. Check for generated file headers
2. Detect minified files via line length
3. Look for source maps indicating bundled code
4. Check for common generated file patterns

### Phase 3: Smart Heuristics
Fine-tune:
1. Learn thresholds from user feedback
2. Handle edge cases (vendored internal code)
3. Support negation patterns (`!vendor/internal/`)

### Detection Confidence Levels
Each suggestion should have a confidence level:
- **High**: Standard paths (`node_modules/`, `vendor/` with autoload.php)
- **Medium**: Pattern matches (`*.pb.go`, `target/generated-sources/`)
- **Low**: Heuristics (high line count, disproportionate entity count)

---

## Complexity Assessment

| Language | Complexity | Why |
|----------|------------|-----|
| Rust | Low | Just `target/`, very predictable |
| Go | Low-Medium | `vendor/` is standard, generated headers help |
| Python | Medium | Multiple venv patterns, bytecode |
| Ruby | Medium | `vendor/bundle` but not always used |
| Java/Kotlin | Medium | Maven vs Gradle, annotation processors |
| C#/.NET | Medium | `bin/obj` easy, source generators harder |
| PHP | Medium | `vendor/` standard, but framework caches vary |
| JavaScript/TS | High | Many bundlers, many conventions, minification |
| C/C++ | Very High | No standard package manager, many build systems |

---

## Definitive Detection Rules (from Gemini Research)

These are high-confidence detection methods that should be treated as authoritative:

| Language | Directory | Definitive Indicator | Confidence |
|----------|-----------|---------------------|------------|
| Go | `vendor/` | `vendor/modules.txt` exists | 100% |
| Node | `node_modules/` | Standard; `.yarn/cache` for Yarn Berry | 100% |
| Python | `venv/`, `.venv/` | `pyvenv.cfg` exists | 100% |
| Ruby | `vendor/bundle/` | `.bundle/config` with `BUNDLE_PATH` | 100% |
| PHP | `vendor/` | `vendor/autoload.php` exists | 100% |
| Rust | `target/` | `Cargo.toml` in parent | 100% |
| C++ | `vcpkg_installed/` | `vcpkg.json` in root | High |
| C++ | `conan_data/` | `conanfile.txt` or `conanfile.py` in root | High |

---

## Generated File Header Patterns (Regex)

Scan the **first 5 lines** of source files for these patterns (case-insensitive):

```regex
^//\s*Code generated by .* DO NOT EDIT\.?$        # Go standard
^//\s*<auto-generated>                             # C# standard
^/\*\s*Auto-generated file\. Do not edit\.\s*\*/  # Generic C/Java
@generated                                         # Facebook/Meta tools
^#\s*This file is auto-generated                   # Python/Ruby
```

---

## Monorepo Detection

**Critical:** Do not assume single root manifest. Walk the tree to find workspace roots.

| Ecosystem | Workspace Indicator | What to do |
|-----------|---------------------|------------|
| JavaScript | `pnpm-workspace.yaml` | Parse `packages` glob |
| JavaScript | `package.json` with `workspaces` field | Parse workspace patterns |
| JavaScript | `lerna.json`, `nx.json`, `turbo.json` | Parse package locations |
| Go | `go.work` | **High priority** - overrides `go.mod` logic |
| Rust | `Cargo.toml` with `[workspace]` | Parse `members` list |

**Warning:** With pnpm/yarn workspaces, local packages may be symlinked into `node_modules/`. Don't blindly exclude.

---

## False Positive Danger Zones

These are areas where standard exclusion rules often fail:

### 1. Test Fixtures (`test/fixtures/`, `spec/fixtures/`)
- **Risk:** May contain intentionally vulnerable code for security testing
- **Fix:** Exclude from defect reporting, but flag for security audits

### 2. Legacy "vendor" directories (Go pre-1.11, PHP pre-Composer)
- **Risk:** Teams copied their own shared libraries into `vendor/`
- **Fix:** Only exclude `vendor/` if dependency manager signature exists (`modules.txt`, `autoload.php`)

### 3. Frontend `public/` assets
- **Risk:** `public/js/vendor/` often has un-minified jQuery/Bootstrap
- **Fix:** Check file hashes against known libraries, or scan anyway

### 4. Ruby `vendor/assets`
- **Risk:** Contains user-modified third-party JS/CSS
- **Fix:** Do NOT blanket exclude `vendor/` in Ruby; only `vendor/bundle/`

### 5. Monkey-patching directories (`lib/ext/`, `config/initializers/`)
- **Risk:** Files named after libraries but contain user modifications
- **Fix:** Never exclude `lib/` or `config/` by default

### 6. Rails `db/schema.rb`
- **Risk:** Auto-generated but defines database truth
- **Fix:** Exclude from linting, but include in security scans (reveals column names)

---

## Additional Generated Code Patterns (from Gemini)

| Language | Pattern | Generator |
|----------|---------|-----------|
| Java/Kotlin | `*_Factory.java` | Dagger |
| Java/Kotlin | `*_MembersInjector.java` | Dagger |
| Flutter/Dart | `*.freezed.dart` | Freezed |
| Flutter/Dart | `*.g.dart` | Various |
| Rust | `bindings.rs` | bindgen (if checked in) |
| C# | `*.g.i.cs` | Incremental generators |

---

## Minification Detection Heuristics

For JavaScript/TypeScript files:

1. **Source map presence:** If `foo.js.map` exists alongside `foo.js` → bundled output
2. **Line length:** Any line > 1000 characters → likely minified
3. **Average line length:** If avg > 500 chars → likely minified
4. **Character entropy:** Very high entropy → minified/obfuscated

---

## Questions to Resolve

1. **Should we scan file contents?** Checking headers adds precision but costs performance.
2. **How do we handle monorepos?** Multiple package.json files, nested projects.
3. **What about test fixtures?** `testdata/`, `fixtures/` - sometimes needed in graph.
4. **Generated but important?** Some generated code (e.g., OpenAPI clients) is part of the API.
5. **User overrides?** How to let users say "actually, include this vendor/ directory"

---

## Sources

- [depcheck](https://www.npmjs.com/package/depcheck) - npm dependency analysis
- [Go Modules Reference](https://go.dev/ref/mod) - Official Go module docs
- [Python venv docs](https://docs.python.org/3/library/venv.html) - Virtual environment structure
- [Cargo Book](https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html) - Rust dependency management
- [Maven Standard Directory Layout](https://maven.apache.org/guides/introduction/introduction-to-the-standard-directory-layout.html)
- [Bundler Gemfiles](https://bundler.io/guides/gemfile.html) - Ruby dependency management
- [Composer Basic Usage](https://getcomposer.org/doc/01-basic-usage.md) - PHP dependency management
- [vcpkg](https://vcpkg.io/) - C++ package management
- [Protobuf Go Generated Code](https://protobuf.dev/reference/go/go-generated/) - Protobuf naming conventions
- [ts-proto](https://github.com/stephenh/ts-proto) - TypeScript protobuf generation
- [source-map-explorer](https://github.com/danvk/source-map-explorer) - Analyzing bundled code
- [nuget-inspector](https://github.com/aboutcode-org/nuget-inspector) - .NET dependency detection
- [KAPT Kotlin docs](https://kotlinlang.org/docs/kapt.html) - Kotlin annotation processing
